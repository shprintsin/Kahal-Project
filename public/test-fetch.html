<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Markdown Fetch Test</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      .container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
      }
      .panel {
        border: 1px solid #ccc;
        padding: 20px;
        border-radius: 8px;
      }
      .panel h2 {
        margin-top: 0;
      }
      #status {
        padding: 10px;
        margin-bottom: 20px;
        border-radius: 4px;
        background: #f0f0f0;
      }
      #status.loading {
        background: #fff3cd;
      }
      #status.success {
        background: #d4edda;
      }
      #status.error {
        background: #f8d7da;
      }
      img {
        max-width: 100%;
        height: auto;
      }
      pre {
        background: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        white-space: pre-wrap;
      }
      button {
        padding: 10px 20px;
        margin: 5px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <h1>R2 Fetch Test - Polltax V50_1762</h1>

    <div id="status">Ready to test...</div>

    <div>
      <button onclick="testDirectFetch()">
        Test Direct Fetch (will fail CORS)
      </button>
      <button onclick="testProxyFetch()">Test API Proxy Fetch</button>
      <button onclick="testBoth()">Test Both</button>
    </div>

    <div class="container">
      <div class="panel">
        <h2>Image (PNG)</h2>
        <div id="imageContainer"></div>
      </div>
      <div class="panel">
        <h2>Markdown (MD)</h2>
        <div id="markdownContainer"></div>
      </div>
    </div>

    <script>
      const IMAGE_URL =
        "https://pub-c084dc5a07ad420f8f56f3973ac35898.r2.dev/collections/Polltax/V50_1762/scans/V50_220_1L.png";
      const MD_URL =
        "https://pub-c084dc5a07ad420f8f56f3973ac35898.r2.dev/collections/Polltax/V50_1762/md/V50_220_1L.md";

      function setStatus(message, type = "") {
        const status = document.getElementById("status");
        status.textContent = message;
        status.className = type;
      }

      async function testDirectFetch() {
        setStatus("Testing direct fetch from R2...", "loading");

        try {
          // Try to fetch markdown directly
          const response = await fetch(MD_URL);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const text = await response.text();

          document.getElementById("markdownContainer").innerHTML = `
                    <h3>✅ Direct fetch SUCCESS!</h3>
                    <pre>${text}</pre>
                `;

          // Try to load image directly
          document.getElementById("imageContainer").innerHTML = `
                    <img src="${IMAGE_URL}" alt="Direct load" />
                `;

          setStatus("✅ Direct fetch worked!", "success");
        } catch (error) {
          setStatus(`❌ Direct fetch failed: ${error.message}`, "error");
          document.getElementById("markdownContainer").innerHTML = `
                    <h3>❌ CORS Error (Expected)</h3>
                    <p>${error.message}</p>
                    <p>This is expected - browser blocks direct R2 fetch due to CORS policy.</p>
                `;
        }
      }

      async function testProxyFetch() {
        setStatus("Testing fetch via API proxy...", "loading");

        try {
          // Fetch markdown via proxy
          const proxyUrl = `/api/proxy/r2?url=${encodeURIComponent(MD_URL)}`;
          console.log("Fetching from proxy:", proxyUrl);

          const response = await fetch(proxyUrl);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          const text = await response.text();

          document.getElementById("markdownContainer").innerHTML = `
                    <h3>✅ Proxy fetch SUCCESS!</h3>
                    <h4>Raw Markdown:</h4>
                    <pre>${text}</pre>
                    <h4>Rendered (simple):</h4>
                    <div style="border: 1px solid #ddd; padding: 10px; background: white;">
                        ${text
                          .split("\\n")
                          .map((line) => `<p>${line}</p>`)
                          .join("")}
                    </div>
                `;

          // For images, we can use proxy too
          const imageProxyUrl = `/api/proxy/r2?url=${encodeURIComponent(
            IMAGE_URL
          )}`;
          document.getElementById("imageContainer").innerHTML = `
                    <img src="${imageProxyUrl}" alt="Via proxy" />
                    <p><small>Loaded via: ${imageProxyUrl}</small></p>
                `;

          setStatus("✅ Proxy fetch worked!", "success");
        } catch (error) {
          setStatus(`❌ Proxy fetch failed: ${error.message}`, "error");
          document.getElementById("markdownContainer").innerHTML = `
                    <h3>❌ Proxy Error</h3>
                    <p>${error.message}</p>
                    <p>Check if the /api/proxy/r2 route exists and is working.</p>
                `;
        }
      }

      async function testBoth() {
        await testDirectFetch();
        await new Promise((resolve) => setTimeout(resolve, 2000));
        await testProxyFetch();
      }

      // Auto-test on load
      window.addEventListener("load", () => {
        setTimeout(testProxyFetch, 500);
      });
    </script>
  </body>
</html>
